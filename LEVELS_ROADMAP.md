# План професійної реалізації рівнів (backend + frontend + DB)

## 1) Поточний стан системи

### Backend (NestJS + Prisma)
- Ігри видаються через `/games` і містять агреговану інформацію по складностях.
- Старт проходження гри: `/attempts/start` з `childProfileId`, `gameId`, `difficulty`.
- Відповідь на завдання: `/attempts/:attemptId/answer`.
- У БД немає окремої сутності `Level`: роль рівня виконує порядок `Task.position` + версія завдання (`TaskVersion`) з певною `difficulty`.

### Frontend (Next.js)
- Є екран вибору складності та екран вибору рівня (`/child/game/[gameId]/levels`).
- Після вибору рівня сторінка гри отримує `level` з query-параметра.

### DB (Prisma/PostgreSQL)
- `Task` визначає послідовність у грі (`position`).
- `TaskVersion` визначає контент і складність (`difficulty`), `isCurrent=true` — активна версія.

## 2) Що вже зроблено в цьому кроці

1. Додано повноцінну підтримку `level` при старті гри:
   - `POST /attempts/start` тепер приймає `level`.
2. На backend обраний рівень інтерпретується як N-те доступне завдання для конкретної складності.
3. Додана валідація `level` (має бути додатнім цілим і існувати для обраної пари game+difficulty).
4. Покращено переходи між завданнями:
   - наступне завдання шукається лише серед тих, що мають `isCurrent=true` для поточної складності.
5. Виправлено підрахунок кількості рівнів у `/games`:
   - рахуємо унікальні `taskId` на складність, а не кількість версій.
6. Frontend тепер передає `level` у `startAttempt(...)` і не дає стартувати без явного вибору рівня.

## 3) Наступні професійні кроки

1. Додати прогрес по рівнях:
   - окрема таблиця `child_level_progress` (childProfileId, gameId, difficulty, maxUnlockedLevel, stars, updatedAt).
2. Додати правила відкриття рівнів:
   - базово: відкритий лише `level=1`, далі відкриття за фактом проходження попереднього.
3. Ввести рейтинг проходження:
   - 1–3 зірки на рівень за точністю + часом.
4. Додати API:
   - `GET /games/:id/levels?difficulty=...` зі статусом locked/unlocked/completed.
5. Додати адмін-інструменти контенту:
   - bulk імпорт/експорт рівнів JSON,
   - валідація структури задач.
6. Тестування:
   - e2e тести для сценарію "вибір складності → рівень → проходження → розблокування наступного".

## 4) Рекомендовані стандарти якості

- Контракт DTO через class-validator (валідація на рівні NestJS pipe).
- Версіонування контенту задач без даунтайму (`TaskVersion`).
- Чіткі інваріанти:
  - один `isCurrent=true` на `taskId + difficulty`.
- Аналітика:
  - лог подій старт/відповідь/фініш для подальшого балансу складності.
